/**

 @Name：layim mobile 2.1.0
 @Author：贤心
 @Site：http://layim.layui.com
 @License：LGPL
    
 */layui.define(["laytpl","upload-mobile","layer-mobile","zepto"],function(a){var b=layui.zepto,c=layui.laytpl,d=layui["layer-mobile"],e=layui["upload-mobile"],f=layui.device(),g="layui-show",h="layim-this",i=20,j={},k=function(){this.v="2.1.0",l(b("body"),"*[layim-event]",function(a){var c=b(this),d=c.attr("layim-event");Q[d]?Q[d].call(this,c,a):""})},l=function(a,c,d){var f,g="function"==typeof c,h=function(a){var c=b(this);c.data("lock")||(f||d.call(this,a),f=!1,c.data("lock","true"),setTimeout(function(){c.removeAttr("data-lock")},c.data("locktime")||0))};return g&&(d=c),a="string"==typeof a?b(a):a,m?void(g?a.on("touchmove",function(){f=!0}).on("touchend",h):a.on("touchmove",c,function(){f=!0}).on("touchend",c,h)):void(g?a.on("click",h):a.on("click",c,h))},m=/Android|iPhone|SymbianOS|Windows Phone|iPad|iPod/.test(navigator.userAgent);d.popBottom=function(a){d.close(d.popBottom.index),d.popBottom.index=d.open(b.extend({type:1,content:a.content||"",shade:!1,className:"layim-layer"},a))},k.prototype.config=function(a){a=a||{},a=b.extend({title:"\u6211\u7684IM",isgroup:0,isNewFriend:!0,voice:"default.mp3",chatTitleColor:"#36373C"},a),u(a)},k.prototype.on=function(a,b){return"function"==typeof b&&(j[a]?j[a].push(b):j[a]=[b]),this},k.prototype.chat=function(a){return window.JSON&&window.JSON.parse?(x(a,-1),this):void 0},k.prototype.panel=function(a){return w(a)},k.prototype.cache=function(){return t},k.prototype.getMessage=function(a){return G(a),this},k.prototype.addList=function(a){return J(a),this},k.prototype.removeList=function(a){return K(a),this},k.prototype.setFriendStatus=function(a,c){var d=b(".layim-friend"+a);d["online"===c?"removeClass":"addClass"]("layim-list-gray")},k.prototype.setChatStatus=function(a){var b=z(),c=b.elem.find(".layim-chat-status");return c.html(a),this},k.prototype.showNew=function(a,b){C(a,b)},k.prototype.content=function(a){return layui.data.content(a)};//列表内容模板
var n=function(a){return a=a||{},"history"===a.type&&(a.item=a.item||"d.sortHistory"),["{{# var length = 0; layui.each("+a.item+", function(i, data){ length++; }}","<li layim-event=\"chat\" data-type=\""+a.type+"\" data-index=\""+(a.index?"{{"+a.index+"}}":("history"===a.type?"{{data.type}}":a.type)+"{{data.id}}")+"\" class=\"layim-"+("history"===a.type?"{{data.type}}":a.type)+"{{data.id}} {{ data.status === \"offline\" ? \"layim-list-gray\" : \"\" }}\"><div><img src=\"{{data.avatar}}\"></div><span>{{ data.username||data.groupname||data.name||\"\u4F5A\u540D\" }}</span><p>{{ data.remark||data.sign||\"\" }}</p><span class=\"layim-msg-status\">new</span></li>","{{# }); if(length === 0){ }}","<li class=\"layim-null\">"+({friend:"\u8BE5\u5206\u7EC4\u4E0B\u6682\u65E0\u597D\u53CB",group:"\u6682\u65E0\u7FA4\u7EC4",history:"\u6682\u65E0\u4EFB\u4F55\u6D88\u606F"}[a.type]||"\u6682\u65E0\u6570\u636E")+"</li>","{{# } }}"].join("")},o=function(a,b,c){return["<div class=\"layim-panel"+(b?" layui-m-anim-left":"")+"\">","<div class=\"layim-title\" style=\"background-color: {{d.base.chatTitleColor}};\">","<p>",c?"<i class=\"layui-icon layim-chat-back\" layim-event=\"back\">&#xe603;</i>":"","{{ d.title || d.base.title }}<span class=\"layim-chat-status\"></span>","{{# if(d.data){ }}","{{# if(d.data.type === \"group\"){ }}","<i class=\"layui-icon layim-chat-detail\" layim-event=\"detail\">&#xe613;</i>","{{# } }}","{{# } }}","</p>","</div>","<div class=\"layui-unselect layim-content\">",a,"</div>","</div>"].join("")},p=["<div class=\"layui-layim\">","<div class=\"layim-tab-content layui-show\">","<ul class=\"layim-list-friend\">","<ul class=\"layui-layim-list layui-show layim-list-history\">",n({type:"history"}),"</ul>","</ul>","</div>","<div class=\"layim-tab-content\">","<ul class=\"layim-list-top\">","{{# if(d.base.isNewFriend){ }}","<li layim-event=\"newFriend\"><i class=\"layui-icon\">&#xe654;</i>\u65B0\u7684\u670B\u53CB<i class=\"layim-new\" id=\"LAY_layimNewFriend\"></i></li>","{{# } if(d.base.isgroup){ }}","<li layim-event=\"group\"><i class=\"layui-icon\">&#xe613;</i>\u7FA4\u804A<i class=\"layim-new\" id=\"LAY_layimNewGroup\"></i></li>","{{# } }}","</ul>","<ul class=\"layim-list-friend\">","{{# layui.each(d.friend, function(index, item){ var spread = d.local[\"spread\"+index]; }}","<li>","<h5 layim-event=\"spread\" lay-type=\"{{ spread }}\"><i class=\"layui-icon\">{{# if(spread === \"true\"){ }}&#xe61a;{{# } else {  }}&#xe602;{{# } }}</i><span>{{ item.groupname||\"\u672A\u547D\u540D\u5206\u7EC4\"+index }}</span><em>(<cite class=\"layim-count\"> {{ (item.list||[]).length }}</cite>)</em></h5>","<ul class=\"layui-layim-list {{# if(spread === \"true\"){ }}"," layui-show","{{# } }}\">",n({type:"friend",item:"item.list",index:"index"}),"</ul>","</li>","{{# }); if(d.friend.length === 0){ }}","<li><ul class=\"layui-layim-list layui-show\"><li class=\"layim-null\">\u6682\u65E0\u8054\u7CFB\u4EBA</li></ul>","{{# } }}","</ul>","</div>","<div class=\"layim-tab-content\">","<ul class=\"layim-list-top\">","{{# layui.each(d.base.moreList, function(index, item){ }}","<li layim-event=\"moreList\" lay-filter=\"{{ item.alias }}\">","<i class=\"layui-icon {{item.iconClass||\"\"}}\">{{item.iconUnicode||\"\"}}</i>{{item.title}}<i class=\"layim-new\" id=\"LAY_layimNew{{ item.alias }}\"></i>","</li>","{{# }); if(!d.base.copyright){ }}","<li layim-event=\"about\"><i class=\"layui-icon\">&#xe60b;</i>\u5173\u4E8E<i class=\"layim-new\" id=\"LAY_layimNewAbout\"></i></li>","{{# } }}","</ul>","</div>","</div>","<ul class=\"layui-unselect layui-layim-tab\">","<li title=\"\u6D88\u606F\" layim-event=\"tab\" lay-type=\"message\" class=\"layim-this\"><i class=\"layui-icon\">&#xe611;</i><span>\u6D88\u606F</span><i class=\"layim-new\" id=\"LAY_layimNewMsg\"></i></li>","<li title=\"\u8054\u7CFB\u4EBA\" layim-event=\"tab\" lay-type=\"friend\"><i class=\"layui-icon\">&#xe612;</i><span>\u8054\u7CFB\u4EBA</span><i class=\"layim-new\" id=\"LAY_layimNewList\"></i></li>","<li title=\"\u66F4\u591A\" layim-event=\"tab\" lay-type=\"more\"><i class=\"layui-icon\">&#xe670;</i><span>\u66F4\u591A</span><i class=\"layim-new\" id=\"LAY_layimNewMore\"></i></li>","</ul>"].join(""),q=function(a){return 10>a?"0"+(0|a):a};//公共面板
layui.data.date=function(a){var b=new Date(a||new Date);return q(b.getMonth()+1)+"-"+q(b.getDate())+" "+q(b.getHours())+":"+q(b.getMinutes())},layui.data.content=function(a){//支持的html标签
var b=function(a){return new RegExp("\\n*\\["+(a||"")+"(pre|div|p|table|thead|th|tbody|tr|td|ul|li|ol|li|dl|dt|dd|h2|h3|h4|h5)([\\s\\S]*?)\\]\\n*","g")};//转义换行 
return a=(a||"").replace(/&(?!#?[a-zA-Z0-9]+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;")//XSS
.replace(/@(\S+)(\s+?|$)/g,"@<a href=\"javascript:;\">$1</a>$2")//转义@
.replace(/face\[([^\s\[\]]+?)\]/g,function(a){//转义表情
var b=a.replace(/^face/g,"");return"<img alt=\""+b+"\" title=\""+b+"\" src=\""+N[b]+"\">"}).replace(/img\[([^\s]+?)\]/g,function(a){//转义图片
return"<img class=\"layui-layim-photos\" src=\""+a.replace(/(^img\[)|(\]$)/g,"")+"\">"}).replace(/file\([\s\S]+?\)\[[\s\S]*?\]/g,function(a){//转义文件
var b=(a.match(/file\(([\s\S]+?)\)\[/)||[])[1],c=(a.match(/\)\[([\s\S]*?)\]/)||[])[1];return b?"<a class=\"layui-layim-file\" href=\""+b+"\" download target=\"_blank\"><i class=\"layui-icon\">&#xe61e;</i><cite>"+(c||b)+"</cite></a>":a}).replace(/audio\[([^\s]+?)\]/g,function(a){//转义音频
return"<div class=\"layui-unselect layui-layim-audio\" layim-event=\"playAudio\" data-src=\""+a.replace(/(^audio\[)|(\]$)/g,"")+"\"><i class=\"layui-icon\">&#xe652;</i><p>\u97F3\u9891\u6D88\u606F</p></div>"}).replace(/video\[([^\s]+?)\]/g,function(a){//转义音频
return"<div class=\"layui-unselect layui-layim-video\" layim-event=\"playVideo\" data-src=\""+a.replace(/(^video\[)|(\]$)/g,"")+"\"><i class=\"layui-icon\">&#xe652;</i></div>"}).replace(/a\([\s\S]+?\)\[[\s\S]*?\]/g,function(a){//转义链接
var b=(a.match(/a\(([\s\S]+?)\)\[/)||[])[1],c=(a.match(/\)\[([\s\S]*?)\]/)||[])[1];return b?"<a href=\""+b+"\" target=\"_blank\">"+(c||b)+"</a>":a}).replace(b(),"<$1 $2>").replace(b("/"),"</$1>")//转移HTML代码
.replace(/\n/g,"<br>"),a};// change
// var elemChatMain = ['<li class="layim-chat-li{{ d.mine ? " layim-chat-mine" : "" }}">'
//   ,'<div class="layim-chat-user"><img src="{{ d.avatar }}"><cite>'
//     ,'{{ d.username||"佚名" }}'
//   ,'</cite></div>'
//   ,'<div class="layim-chat-text">{{ layui.data.content(d.content||"&nbsp;") }}</div>'
// ,'</li>'].join('');
// to 
var r,s,t={message:{},chat:[]},u=function(a){var d=a.init||{};return(mine=d.mine||{},local=layui.data("layim-mobile")[mine.id]||{},obj={base:a,local:local,mine:mine,history:local.history||[]},create=function(d){var e=d.mine||{},f=layui.data("layim-mobile")[e.id]||{},g={base:a//基础配置信息
,local:f//本地数据
,mine:e//我的用户信息
,friend:d.friend||[]//联系人信息
,group:d.group||[]//群组信息
,history:f.history||[]//历史会话信息
};g.sortHistory=A(g.history,"historyTime"),t=b.extend(t,g),v(c(o(p)).render(g)),layui.each(j.ready,function(a,b){b&&b(g)})},t=b.extend(t,obj),a.brief)?layui.each(j.ready,function(a,b){b&&b(obj)}):void create(d)},v=function(a){return d.open({type:1,shade:!1,shadeClose:!1,anim:-1,content:a,success:function(a){r=b(a),y(r.find(".layui-layim")),t.base.tabIndex&&Q.tab(b(".layui-layim-tab>li").eq(t.base.tabIndex))}})},w=function(a,e){a=a||{};var f=b.extend({},t,{title:a.title||"",data:a.data});return d.open({type:1,shade:!1,shadeClose:!1,anim:-1,content:c(o(a.tpl,-1!==e,!0)).render(f),success:function(c){var d=b(c);d.prev().find(".layim-panel").addClass("layui-m-anim-lout"),a.success&&a.success(c),a.isChat||y(d.find(".layim-content"))},end:a.end})},x=function(a,c){return(a=a||{},!a.id)?d.msg("\u975E\u6CD5\u7528\u6237"):(d.close(x.index),x.index=w({tpl:"<div class=\"layim-chat layim-chat-{{d.data.type}}\"><div class=\"layim-chat-main\"><ul></ul></div><div class=\"layim-chat-footer\"><div class=\"layim-chat-send\"><input type=\"text\" autocomplete=\"off\"><button class=\"layim-send layui-disabled\" layim-event=\"send\">\u53D1\u9001</button></div><div class=\"layim-chat-tool\" data-json=\"{{encodeURIComponent(JSON.stringify(d.data))}}\"><span class=\"layui-icon layim-tool-face\" title=\"\u9009\u62E9\u8868\u60C5\" layim-event=\"face\">&#xe60c;</span>{{# if(d.base && d.base.uploadImage){ }}<span class=\"layui-icon layim-tool-image\" title=\"\u4E0A\u4F20\u56FE\u7247\" layim-event=\"image\">&#xe60d;<input type=\"file\" name=\"file\" accept=\"image/*\"></span>{{# }; }}{{# if(d.base && d.base.uploadFile){ }}<span class=\"layui-icon layim-tool-image\" title=\"\u53D1\u9001\u6587\u4EF6\" layim-event=\"image\" data-type=\"file\">&#xe61d;<input type=\"file\" name=\"file\"></span>{{# }; }}{{# layui.each(d.base.tool, function(index, item){ }}<span class=\"layui-icon  {{item.iconClass||\"\"}} layim-tool-{{item.alias}}\" title=\"{{item.title}}\" layim-event=\"extend\" lay-filter=\"{{ item.alias }}\">{{item.iconUnicode||\"\"}}</span>{{# }); }}</div></div></div>",data:a,title:a.name,isChat:!0,success:function(c){s=b(c),M(),I(),delete t.message[a.type+a.id],C("Msg");//聊天窗口的切换监听
var d=z(),e=d.elem.find(".layim-chat-main");layui.each(j.chatChange,function(a,b){b&&b(d)}),y(e),d.textarea.on("focus",function(){setTimeout(function(){e.scrollTop(e[0].scrollHeight+1e3)},500)})},end:function(){s=null,D.time=0}},c))},y=function(a){f.ios&&a.on("touchmove",function(b){var c=a.scrollTop();0>=c&&(a.scrollTop(1),b.preventDefault(b)),0>=this.scrollHeight-c-a.height()&&(a.scrollTop(a.scrollTop()-1),b.preventDefault(b))})},z=function(){if(!s)return{};var a=s.find(".layim-chat"),b=JSON.parse(decodeURIComponent(a.find(".layim-chat-tool").data("json")));return{elem:a,data:b,textarea:a.find("input")}},A=function(a,b,c){var d=[];return layui.each(a,function(a,b){d.push(b)}),d.sort(function(a,c){var d=a[b],e=c[b];return e<d?-1:e>d?1:0}),c&&d.reverse(),d},B=function(a){var b=layui.data("layim-mobile")[t.mine.id]||{},d={},e=b.history||{},f=e[a.type+a.id];if(r){var h=r.find(".layim-list-history");a.historyTime=new Date().getTime(),a.sign=a.content,e[a.type+a.id]=a,b.history=e,layui.data("layim-mobile",{key:t.mine.id,value:b});var i=h.find(".layim-"+a.type+a.id),j=(t.message[a.type+a.id]||[]).length//未读消息数
,k=function(){i=h.find(".layim-"+a.type+a.id),i.find("p").html(a.content),0<j&&i.find(".layim-msg-status").html(j).addClass(g)};if(0<i.length)k(),h.prepend(i.clone()),i.remove();else{d[a.type+a.id]=a;var l=c(n({type:"history",item:"d.data"})).render({data:d});h.prepend(l),k(),h.find(".layim-null").remove()}C("Msg")}},C=function(a,c){if(!c){var c;layui.each(t.message,function(){return c=!0,!1})}b("#LAY_layimNew"+a)[c?"addClass":"removeClass"](g)},D=function(){var a={username:t.mine?t.mine.username:"\u8BBF\u5BA2",avatar:t.mine?t.mine.avatar:layui.cache.dir+"css/pc/layim/skin/logo.jpg",id:t.mine?t.mine.id:null,mine:!0},e=z(),f=e.elem.find(".layim-chat-main ul"),g=e.data,h=t.base.maxLength||3e3,k=new Date().getTime(),l=e.textarea;if(a.content=l.val(),""!==a.content){if(a.content.length>h)return d.msg("\u5185\u5BB9\u6700\u957F\u4E0D\u80FD\u8D85\u8FC7"+h+"\u4E2A\u5B57\u7B26");60000<k-(D.time||0)&&(f.append("<li class=\"layim-chat-system\"><span>"+layui.data.date()+"</span></li>"),D.time=k);// change
// ul.append(laytpl(elemChatMain).render(data));
// to
var m=b(c("<li class=\"layim-chat-li{{ d.mine ? \" layim-chat-mine\" : \"\" }}\" {{# if(d.cid){ }}data-cid=\"{{d.cid}}\"{{# } }}><div class=\"layim-chat-user\"><img src=\"{{ d.avatar }}\"><cite>{{ d.username||\"\u4F5A\u540D\" }}</cite></div><div class=\"layim-chat-text\" style=\"position:relative;\"><img class=\"messagefail_img\" src=\"https://i.loli.net/2019/04/12/5cb04b95be706.png\" /><span style=\"padding-right:10px\">{{ layui.data.content(d.content||\"&nbsp;\") }}</span><div class=\"mytips\">\u5220\u9664</div></div></li>").render(a));if(j.beforeSendMessage instanceof Array)for(var n=0;n<j.beforeSendMessage.length;n++)// 如果此回调返回值为 false, 表示此消息不发送
if(!j.beforeSendMessage[n](m,e))return;f.append(m);// end
var o={mine:a,to:g},p={username:o.mine.username,avatar:o.mine.avatar,id:g.id,type:g.type,content:o.mine.content,timestamp:k,mine:!0};H(p),layui.each(j.sendMessage,function(a,b){b&&b(o,m)}),g.content=a.content,B(g),L(),l.val(""),l.next().addClass("layui-disabled")}},E=function(){var a=document.createElement("audio");a.src=layui.cache.dir+"css/modules/layim/voice/"+t.base.voice,a.play()},F={},G=function(a){a=a||{};var d={},e=z(),f=e.data||{},g=f.id==a.id&&f.type==a.type;//是否当前打开联系人的消息
a.timestamp=a.timestamp||new Date().getTime(),a.system||H(a),F=JSON.parse(JSON.stringify(a)),t.base.voice&&E(),(s||!a.content)&&g||(t.message[a.type+a.id]?t.message[a.type+a.id].push(a):t.message[a.type+a.id]=[a]);//记录聊天面板队列
var d={};if("friend"===a.type){var h;layui.each(t.friend,function(b,c){if(layui.each(c.list,function(b,c){if(c.id==a.id)return a.type="friend",a.name=c.username,h=!0}),h)return!0}),h||(a.temporary=!0)}else"group"===a.type?layui.each(t.group,function(b,c){if(c.id==a.id)return a.type="group",a.name=a.groupname=c.groupname,d.avatar=c.avatar,!0}):a.name=a.name||a.username||a.groupname;var k=b.extend({},a,{avatar:d.avatar||a.avatar});if("group"===a.type&&delete k.username,B(k),s&&g){var l=s.find(".layim-chat"),m=l.find(".layim-chat-main ul");//系统消息
if(a.system)m.append("<li class=\"layim-chat-system\"><span>"+a.content+"</span></li>");else if(""!==a.content.replace(/\s/g,"")){60000<a.timestamp-(D.time||0)&&(m.append("<li class=\"layim-chat-system\"><span>"+layui.data.date(a.timestamp)+"</span></li>"),D.time=a.timestamp);// change
// ul.append(laytpl(elemChatMain).render(data));
// to
var n=b(c("<li class=\"layim-chat-li{{ d.mine ? \" layim-chat-mine\" : \"\" }}\" {{# if(d.cid){ }}data-cid=\"{{d.cid}}\"{{# } }}><div class=\"layim-chat-user\"><img src=\"{{ d.avatar }}\"><cite>{{ d.username||\"\u4F5A\u540D\" }}</cite></div><div class=\"layim-chat-text\" style=\"position:relative;\"><img class=\"messagefail_img\" src=\"https://i.loli.net/2019/04/12/5cb04b95be706.png\" /><span style=\"padding-right:10px\">{{ layui.data.content(d.content||\"&nbsp;\") }}</span><div class=\"mytips\">\u5220\u9664</div></div></li>").render(a));if(j.afterGetMessage instanceof Array)for(var o=0;o<j.afterGetMessage.length;o++)j.afterGetMessage[o](n,!0,e,a);m.append(n)}L()}},H=function(a){var b=layui.data("layim-mobile")[t.mine.id]||{},c=b.chatlog||{};c[a.type+a.id]?(c[a.type+a.id].push(a),c[a.type+a.id].length>i&&c[a.type+a.id].shift()):c[a.type+a.id]=[a],b.chatlog=c,layui.data("layim-mobile",{key:t.mine.id,value:b})},I=function(){var a=layui.data("layim-mobile")[t.mine.id]||{},d=z(),e=a.chatlog||{},f=d.elem.find(".layim-chat-main ul");layui.each(e[d.data.type+d.data.id],function(a,e){new Date().getTime()>e.timestamp&&e.timestamp-(D.time||0)>60000&&(f.append("<li class=\"layim-chat-system\"><span>"+layui.data.date(e.timestamp)+"</span></li>"),D.time=e.timestamp);// change
// ul.append(laytpl(elemChatMain).render(item));
// to
var g=b(c("<li class=\"layim-chat-li{{ d.mine ? \" layim-chat-mine\" : \"\" }}\" {{# if(d.cid){ }}data-cid=\"{{d.cid}}\"{{# } }}><div class=\"layim-chat-user\"><img src=\"{{ d.avatar }}\"><cite>{{ d.username||\"\u4F5A\u540D\" }}</cite></div><div class=\"layim-chat-text\" style=\"position:relative;\"><img class=\"messagefail_img\" src=\"https://i.loli.net/2019/04/12/5cb04b95be706.png\" /><span style=\"padding-right:10px\">{{ layui.data.content(d.content||\"&nbsp;\") }}</span><div class=\"mytips\">\u5220\u9664</div></div></li>").render(e));if(j.afterGetMessage instanceof Array)for(var h=0;h<j.afterGetMessage.length;h++)j.afterGetMessage[h](g,!0,d,e);f.append(g)}),L()},J=function(a){var b,e={},f=r.find(".layim-list-"+a.type);if(t[a.type])if("friend"===a.type)layui.each(t.friend,function(c,f){if(a.groupid==f.id)return(layui.each(t.friend[c].list,function(c,d){if(d.id==a.id)return b=!0}),b)?d.msg("\u597D\u53CB ["+(a.username||"")+"] \u5DF2\u7ECF\u5B58\u5728\u5217\u8868\u4E2D",{anim:6}):(t.friend[c].list=t.friend[c].list||[],e[t.friend[c].list.length]=a,a.groupIndex=c,t.friend[c].list.push(a),!0)});else if("group"===a.type){if(layui.each(t.group,function(c,d){if(d.id==a.id)return b=!0}),b)return d.msg("\u60A8\u5DF2\u662F ["+(a.groupname||"")+"] \u7684\u7FA4\u6210\u5458",{anim:6});e[t.group.length]=a,t.group.push(a)}if(!b){var g=c(n({type:a.type,item:"d.data",index:"friend"===a.type?"data.groupIndex":null})).render({data:e});if("friend"===a.type){var h=f.children("li").eq(a.groupIndex);h.find(".layui-layim-list").append(g),h.find(".layim-count").html(t.friend[a.groupIndex].list.length),h.find(".layim-null")[0]&&h.find(".layim-null").remove()}else"group"===a.type&&(f.append(g),f.find(".layim-null")[0]&&f.find(".layim-null").remove())}},K=function(a){var b=r.find(".layim-list-"+a.type);t[a.type]&&("friend"===a.type?layui.each(t.friend,function(c,d){layui.each(d.list,function(d,e){if(a.id==e.id){var f=b.children("li").eq(c),g=f.find(".layui-layim-list").children("li");return f.find(".layui-layim-list").children("li").eq(d).remove(),t.friend[c].list.splice(d,1),f.find(".layim-count").html(t.friend[c].list.length),0===t.friend[c].list.length&&f.find(".layui-layim-list").html("<li class=\"layim-null\">\u8BE5\u5206\u7EC4\u4E0B\u5DF2\u65E0\u597D\u53CB\u4E86</li>"),!0}})}):"group"===a.type&&layui.each(t.group,function(c,d){if(a.id==d.id)return b.children("li").eq(c).remove(),t.group.splice(c,1),0===t.group.length&&b.html("<li class=\"layim-null\">\u6682\u65E0\u7FA4\u7EC4</li>"),!0}))},L=function(){var a=z(),b=a.elem.find(".layim-chat-main"),c=b.find("ul"),d=c.children(".layim-chat-li");if(d.length>=i){var e=d.eq(0);e.prev().remove(),c.prev().hasClass("layim-chat-system")||c.before("<div class=\"layim-chat-system\"><span layim-event=\"chatLog\">\u67E5\u770B\u66F4\u591A\u8BB0\u5F55</span></div>"),e.remove()}b.scrollTop(b[0].scrollHeight+1e3)},M=function(){var a=z(),b=a.textarea,c=b.next();b.off("keyup").on("keyup",function(a){var d=a.keyCode;13===d&&(a.preventDefault(),D()),c[""===b.val()?"addClass":"removeClass"]("layui-disabled")})},N=function(){var a={};return layui.each(["[\u5FAE\u7B11]","[\u563B\u563B]","[\u54C8\u54C8]","[\u53EF\u7231]","[\u53EF\u601C]","[\u6316\u9F3B]","[\u5403\u60CA]","[\u5BB3\u7F9E]","[\u6324\u773C]","[\u95ED\u5634]","[\u9119\u89C6]","[\u7231\u4F60]","[\u6CEA]","[\u5077\u7B11]","[\u4EB2\u4EB2]","[\u751F\u75C5]","[\u592A\u5F00\u5FC3]","[\u767D\u773C]","[\u53F3\u54FC\u54FC]","[\u5DE6\u54FC\u54FC]","[\u5618]","[\u8870]","[\u59D4\u5C48]","[\u5410]","[\u54C8\u6B20]","[\u62B1\u62B1]","[\u6012]","[\u7591\u95EE]","[\u998B\u5634]","[\u62DC\u62DC]","[\u601D\u8003]","[\u6C57]","[\u56F0]","[\u7761]","[\u94B1]","[\u5931\u671B]","[\u9177]","[\u8272]","[\u54FC]","[\u9F13\u638C]","[\u6655]","[\u60B2\u4F24]","[\u6293\u72C2]","[\u9ED1\u7EBF]","[\u9634\u9669]","[\u6012\u9A82]","[\u4E92\u7C89]","[\u5FC3]","[\u4F24\u5FC3]","[\u732A\u5934]","[\u718A\u732B]","[\u5154\u5B50]","[ok]","[\u8036]","[good]","[NO]","[\u8D5E]","[\u6765]","[\u5F31]","[\u8349\u6CE5\u9A6C]","[\u795E\u9A6C]","[\u56E7]","[\u6D6E\u4E91]","[\u7ED9\u529B]","[\u56F4\u89C2]","[\u5A01\u6B66]","[\u5965\u7279\u66FC]","[\u793C\u7269]","[\u949F]","[\u8BDD\u7B52]","[\u8721\u70DB]","[\u86CB\u7CD5]"],function(b,c){a[c]=layui.cache.dir+"images/face/"+b+".gif"}),a}(),O=layui.stope,P=function(a,b,c){var d,e=a.value;c||a.focus(),document.selection?(d=document.selection.createRange(),document.selection.empty(),d.text=b):(d=[e.substring(0,a.selectionStart),b,e.substr(a.selectionEnd)],c||a.focus(),a.value=d.join(""))},Q={//弹出聊天面板
chat:function(a){var c=layui.data("layim-mobile")[t.mine.id]||{},d=a.data("type"),e=a.data("index"),f=a.attr("data-list")||a.index(),h={};"friend"===d?h=t[d][e].list[f]:"group"===d?h=t[d][f]:"history"===d&&(h=(c.history||{})[e]||{}),h.name=h.name||h.username||h.groupname,"history"!==d&&(h.type=d),x(h,!0),b(".layim-"+h.type+h.id).find(".layim-msg-status").removeClass(g)}//展开联系人分组
,spread:function(a){var b=a.attr("lay-type"),c="true"===b?"false":"true",d=layui.data("layim-mobile")[t.mine.id]||{};a.next()["true"===b?"removeClass":"addClass"](g),d["spread"+a.parent().index()]=c,layui.data("layim-mobile",{key:t.mine.id,value:d}),a.attr("lay-type",c),a.find(".layui-icon").html("true"===c?"&#xe61a;":"&#xe602;")}//底部导航切换
,tab:function(a){var b=a.index();a.addClass(h).siblings().removeClass(h),r.find(".layim-tab-content").eq(b).addClass(g).siblings(".layim-tab-content").removeClass(g)}//返回到上一个面板
,back:function(a){var b=a.parents(".layui-m-layer").eq(0),c=b.attr("index");setTimeout(function(){d.close(c)},300),a.parents(".layim-panel").eq(0).removeClass("layui-m-anim-left").addClass("layui-m-anim-rout"),b.prev().find(".layim-panel").eq(0).removeClass("layui-m-anim-lout").addClass("layui-m-anim-right"),layui.each(j.back,function(a,b){setTimeout(function(){b&&b()},200)})}//发送聊天内容
,send:function(){D()}//表情
,face:function(a,c){var e="",f=z(),g=f.textarea;layui.each(N,function(a,b){e+="<li title=\""+a+"\"><img src=\""+b+"\"></li>"}),e="<ul class=\"layui-layim-face\">"+e+"</ul>",d.popBottom({content:e,success:function(a){var c=b(a).find(".layui-layim-face").children("li");l(c,function(){return P(g[0],"face"+this.title+" ",!0),g.next()[""===g.val()?"addClass":"removeClass"]("layui-disabled"),!1})}});var h=b(document);m?h.off("touchend",Q.faceHide).on("touchend",Q.faceHide):h.off("click",Q.faceHide).on("click",Q.faceHide),O(c)},faceHide:function(){d.close(d.popBottom.index),b(document).off("touchend",Q.faceHide).off("click",Q.faceHide)}//图片或一般文件
,image:function(a){var b=a.data("type")||"images",c=z(),f=t.base[{images:"uploadImage",file:"uploadFile"}[b]]||{};e({url:f.url||"",method:f.type,elem:a.find("input")[0],unwrap:!0,type:b,success:function(a){0==a.code?(a.data=a.data||{},"images"===b?P(c.textarea[0],"img["+(a.data.src||"")+"]"):"file"===b&&P(c.textarea[0],"file("+(a.data.src||"")+")["+(a.data.name||"\u4E0B\u8F7D\u6587\u4EF6")+"]"),D()):d.msg(a.msg||"\u4E0A\u4F20\u5931\u8D25")}})}//扩展工具栏
,extend:function(a){var b=a.attr("lay-filter"),c=z();layui.each(j["tool("+b+")"],function(b,d){d&&d.call(a,function(a){P(c.textarea[0],a)},D,c)})}//弹出新的朋友面板
,newFriend:function(){layui.each(j.newFriend,function(a,b){b&&b()})}//弹出群组面板
,group:function(){w({title:"\u7FA4\u804A",tpl:["<div class=\"layui-layim-list layim-list-group\">",n({type:"group",item:"d.group"}),"</div>"].join(""),data:{}})}//查看群组成员
,detail:function(){var a=z();layui.each(j.detail,function(b,c){c&&c(a.data)})}//播放音频
,playAudio:function(a){var b=a.data("audio"),c=b||document.createElement("audio"),e=function(){c.pause(),a.removeAttr("status"),a.find("i").html("&#xe652;")};return a.data("error")?d.msg("\u64AD\u653E\u97F3\u9891\u6E90\u5F02\u5E38"):c.play?void(a.attr("status")?e():(b||(c.src=a.data("src")),c.play(),a.attr("status","pause"),a.data("audio",c),a.find("i").html("&#xe651;"),c.onended=function(){e()},c.onerror=function(){d.msg("\u64AD\u653E\u97F3\u9891\u6E90\u5F02\u5E38"),a.data("error",!0),e()})):d.msg("\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301audio")}//播放视频
,playVideo:function(a){var b=a.data("src"),c=document.createElement("video");return c.play?void(d.close(Q.playVideo.index),Q.playVideo.index=d.open({type:1,anim:!1,style:"width: 100%; height: 50%;",content:"<div style=\"background-color: #000; height: 100%;\"><video style=\"position: absolute; width: 100%; height: 100%;\" src=\""+b+"\" autoplay=\"autoplay\"></video></div>"})):d.msg("\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301video")}//聊天记录
,chatLog:function(){var a=z();layui.each(j.chatlog,function(b,c){c&&c(a.data,a.elem.find(".layim-chat-main>ul"))})}//更多列表
,moreList:function(a){var b=a.attr("lay-filter");layui.each(j.moreList,function(a,c){c&&c({alias:b})})}//关于
,about:function(){d.open({content:"<p style=\"padding-bottom: 5px;\">LayIM\u5C5E\u4E8E\u4ED8\u8D39\u4EA7\u54C1\uFF0C\u6B22\u8FCE\u901A\u8FC7\u5B98\u7F51\u83B7\u5F97\u6388\u6743\uFF0C\u4FC3\u8FDB\u826F\u6027\u53D1\u5C55\uFF01</p><p>\u5F53\u524D\u7248\u672C\uFF1Alayim mobile v2.1.0</p><p>\u7248\u6743\u6240\u6709\uFF1A<a href=\"http://layim.layui.com\" target=\"_blank\">layim.layui.com</a></p>",className:"layim-about",shadeClose:!1,btn:"\u6211\u77E5\u9053\u4E86"})}};// end
//处理初始化信息
//暴露接口
a("layim-mobile",new k)}).addcss("modules/layim/mobile/layim.css?v=2.10","skinlayim-mobilecss");