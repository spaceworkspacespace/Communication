<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>聊天记录</title>

    <link rel="stylesheet" href="__STATIC__/layim-v3.8.0/css/layui.css">
    <style>
        body .layim-chat-main {
            height: auto;
        }
        #LAY_view > li:last-of-type {
            margin: 0;
            padding: 0;
            font-size: 14px;
            min-height: auto;
            text-align: center;
        }
  </style>
</head>

<body>
    <div id="app" class="layim-chat-main">
        <chat-content :records="records" :id="id" @onxpull="pull" />
    </div>


    <div id="LAY_page" style="margin: 0 10px;"></div>


    <script id="x-chat-content" type="text/x-template">
        <ul id="LAY_view">
            <li v-for="record of records" :class="[ record.id !== id? '': 'layim-chat-mine']">
                <div class="layim-chat-user">
                    <img :src="record.avatar || 'https://i.loli.net/2018/12/10/5c0de4003a282.png'">
                    <cite><i>{{ record.date }}</i>{{ record.username }}</cite>
                </div>
                <div class="layim-chat-text">{{ record.content }}</div>
            </li>
            <li><a @click.prevent="$emit('onxpull')" href="#">点击加载更多</a></li>
        </ul>
    </script>

    <script src="__STATIC__/layim-v3.8.0/layui.js"></script>
    <script src="__STATIC__/libs/jquery-3.3.1.min.js"></script>
    <script src="__STATIC__/libs/vue-2.6.9.js"></script>
    <script type="text/javascript">
        
        layui.use(['layim', 'laypage'], function(){
            var layim = layui.layim
            ,layer = layui.layer
            ,laytpl = layui.laytpl
            ,$ = layui.jquery
            ,laypage = layui.laypage;
        });

        new Vue({
            el: "#app",
            data: function () {
                return {
                    id: null,
                    pageNo: 0,
                    records: [],
                }
            },
            beforeMount: function () {
                this.pull(this.pageNo++);
            },
            methods: {
                pull: function (pageNo) {
                    if (!Number.isInteger(pageNo)) pageNo = this.pageNo++;
                    $.ajax({
                        url: "/im/chat/record" + location.search + "&no=" + pageNo,
                        context: this,
                        method: "GET",
                        success: function (data, status, xhr) {
                            if (data.code) {
                                layer.msg(data.msg);
                            } else {
                                this.id = data.data.id;
                                if (data.data.records.length) {
                                    this.records = this.records.concat(data.data.records);
                                } else {
                                    layer.msg("没有更多数据了~");
                                }
                            }
                        },
                        error: function (xhr, status) {
                            layer.msg("访问失败, 请稍后重试~");
                        }
                    })
                },
                onScroll: function(event) {
                    console.log(event);
                }
            },
            components: {
                "chat-content": {
                    props: ["records", "id"],
                    template: "#x-chat-content"
                }
            }
        });
    </script>
</body>

</html>